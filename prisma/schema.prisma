// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String?
  role          UserRole  @default(NURSE)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  doctor        Doctor?
  nurse         Nurse?
  labTechnician LabTechnician?
  pharmacist    Pharmacist?
  activityLogs  ActivityLog[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  LAB_TECHNICIAN
  RADIOLOGIST
  PHARMACIST
  ACCOUNTANT
}

model Doctor {
  id                 String   @id @default(cuid())
  userId             String   @unique
  licenseNumber      String   @unique
  specialization     String
  qualification      String
  experience         Int // years of experience
  consultationFee    Float
  availableFrom      String // e.g., "09:00"
  availableTo        String // e.g., "17:00"
  department         String
  maxPatientsPerDay  Int      @default(20)
  phone              String?
  email              String?
  isAvailable        Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  prescriptions Prescription[]
  visits       Visit[]
  doctorSchedules DoctorSchedule[]

  @@map("doctors")
}

model DoctorSchedule {
  id        String   @id @default(cuid())
  doctorId  String
  dayOfWeek Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime String   // e.g., "09:00"
  endTime   String   // e.g., "17:00"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, dayOfWeek])
  @@map("doctor_schedules")
}

model Nurse {
  id         String   @id @default(cuid())
  userId     String   @unique
  department String
  shift      String   // DAY, NIGHT, SWING
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  nurseNotes NurseNote[]

  @@map("nurses")
}

model Patient {
  id           String    @id @default(cuid())
  mrn          String    @unique // Medical Record Number
  firstName    String
  lastName     String
  dateOfBirth  DateTime
  gender       Gender
  phoneNumber  String
  email        String?
  address      String
  emergencyContact String
  emergencyPhone   String
  bloodGroup   String?
  allergies    String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  appointments Appointment[]
  visits       Visit[]
  admissions   Admission[]
  labOrders    LabOrder[]
  radiologyOrders RadiologOrder[]
  prescriptions   Prescription[]
  bills           Bill[]
  pharmacyDispenses PharmacyDispense[]
  billingRecords    PatientBilling[]

  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model Appointment {
  id          String            @id @default(cuid())
  patientId   String
  doctorId    String
  appointmentDate DateTime
  appointmentTime String        // e.g., "14:30"
  duration    Int               @default(30) // minutes
  reason      String
  status      AppointmentStatus @default(SCHEDULED)
  notes       String?
  fee         Float             @default(0) // Consultation fee
  isPaid      Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor  @relation(fields: [doctorId], references: [id])
  visit   Visit?

  @@unique([doctorId, appointmentDate, appointmentTime])
  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Visit {
  id            String    @id @default(cuid())
  patientId     String
  doctorId      String
  appointmentId String?   @unique
  visitDate     DateTime  @default(now())
  visitType     VisitType @default(OPD)
  chiefComplaint String
  presentIllness String?
  pastHistory   String?
  examination   String?
  diagnosis     String?
  treatment     String?
  followUpDate  DateTime?
  status        VisitStatus @default(ACTIVE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  patient     Patient      @relation(fields: [patientId], references: [id])
  doctor      Doctor       @relation(fields: [doctorId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  vitals      Vital[]
  nurseNotes  NurseNote[]

  @@map("visits")
}

enum VisitType {
  OPD
  IPD
  EMERGENCY
}

enum VisitStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model Vital {
  id              String   @id @default(cuid())
  visitId         String
  systolicBP      Int?     // mmHg
  diastolicBP     Int?     // mmHg
  heartRate       Int?     // bpm
  temperature     Float?   // Celsius
  respiratoryRate Int?     // per minute
  oxygenSaturation Float?  // percentage
  weight          Float?   // kg
  height          Float?   // cm
  bmi             Float?   // calculated
  recordedAt      DateTime @default(now())
  recordedBy      String   // user who recorded

  visit Visit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@map("vitals")
}

model NurseNote {
  id        String   @id @default(cuid())
  visitId   String
  nurseId   String
  note      String
  noteType  String   // GENERAL, MEDICATION, OBSERVATION, etc.
  recordedAt DateTime @default(now())

  visit Visit @relation(fields: [visitId], references: [id], onDelete: Cascade)
  nurse Nurse @relation(fields: [nurseId], references: [id])

  @@map("nurse_notes")
}

model Ward {
  id          String   @id @default(cuid())
  name        String   @unique
  wardType    String   // ICU, GENERAL, PRIVATE, etc.
  totalBeds   Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  beds Bed[]

  @@map("wards")
}

model Bed {
  id          String    @id @default(cuid())
  wardId      String
  bedNumber   String
  bedType     String    // GENERAL, ICU, PRIVATE
  pricePerDay Float     @default(0) // Daily bed charge
  isOccupied  Boolean   @default(false)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  ward       Ward        @relation(fields: [wardId], references: [id])
  admissions Admission[]

  @@unique([wardId, bedNumber])
  @@map("beds")
}

model Admission {
  id                   String           @id @default(cuid())
  patientId            String
  bedId                String
  admissionDate        DateTime         @default(now())
  expectedDischargeDate DateTime?
  dischargeDate        DateTime?
  reason               String
  admittingDoctorId    String
  status               AdmissionStatus  @default(ADMITTED)
  notes                String?
  totalBedCharges      Float            @default(0)
  isPaid               Boolean          @default(false)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  bed     Bed     @relation(fields: [bedId], references: [id])

  @@map("admissions")
}

enum AdmissionStatus {
  ADMITTED
  DISCHARGED
  TRANSFERRED
}

model LabTest {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique
  category    String   // HEMATOLOGY, BIOCHEMISTRY, MICROBIOLOGY, etc.
  price       Float
  normalRange String?
  unit        String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  labOrderItems LabOrderItem[]

  @@map("lab_tests")
}

model LabOrder {
  id          String         @id @default(cuid())
  patientId   String
  orderNumber String         @unique
  orderDate   DateTime       @default(now())
  urgency     TestUrgency    @default(ROUTINE)
  status      LabOrderStatus @default(PENDING)
  notes       String?
  orderedBy   String         // doctor id or user id
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  patient      Patient        @relation(fields: [patientId], references: [id])
  orderItems   LabOrderItem[]

  @@map("lab_orders")
}

enum TestUrgency {
  ROUTINE
  URGENT
  EMERGENCY
}

enum LabOrderStatus {
  PENDING
  COLLECTED
  PROCESSING
  COMPLETED
  VERIFIED
  REPORTED
}

model LabOrderItem {
  id          String            @id @default(cuid())
  orderId     String
  testId      String
  result      String?
  resultDate  DateTime?
  verifiedBy  String?           // lab technician id
  status      LabOrderItemStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  order   LabOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  test    LabTest  @relation(fields: [testId], references: [id])

  @@unique([orderId, testId])
  @@map("lab_order_items")
}

enum LabOrderItemStatus {
  PENDING
  COLLECTED
  PROCESSING
  COMPLETED
  VERIFIED
}

model LabTechnician {
  id         String   @id @default(cuid())
  userId     String   @unique
  department String   // HEMATOLOGY, BIOCHEMISTRY, etc.
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("lab_technicians")
}

model RadiologTest {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique
  category    String   // X-RAY, CT, MRI, ULTRASOUND, etc.
  price       Float
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  radiologyOrderItems RadiologOrderItem[]

  @@map("radiology_tests")
}

model RadiologOrder {
  id          String              @id @default(cuid())
  patientId   String
  orderNumber String              @unique
  orderDate   DateTime            @default(now())
  urgency     TestUrgency         @default(ROUTINE)
  status      RadiologOrderStatus @default(PENDING)
  notes       String?
  orderedBy   String              // doctor id or user id
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  patient    Patient             @relation(fields: [patientId], references: [id])
  orderItems RadiologOrderItem[]

  @@map("radiology_orders")
}

enum RadiologOrderStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  VERIFIED
  REPORTED
}

model RadiologOrderItem {
  id          String                   @id @default(cuid())
  orderId     String
  testId      String
  result      String?
  resultDate  DateTime?
  verifiedBy  String?                  // radiologist id
  status      RadiologOrderItemStatus @default(PENDING)
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt

  order RadiologOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  test  RadiologTest  @relation(fields: [testId], references: [id])

  @@unique([orderId, testId])
  @@map("radiology_order_items")
}

enum RadiologOrderItemStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  VERIFIED
}

model Drug {
  id           String   @id @default(cuid())
  name         String   @unique
  genericName  String
  strength     String   // e.g., "500mg"
  dosageForm   String   // TABLET, CAPSULE, SYRUP, etc.
  manufacturer String
  price        Float
  minStock     Int      @default(10)
  maxStock     Int      @default(1000)
  currentStock Int      @default(0)
  expiryDate   DateTime?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  prescriptionItems PrescriptionItem[]
  pharmacyIssues    PharmacyIssue[]
  pharmacyDispenses PharmacyDispense[]

  @@map("drugs")
}

model PharmacyDispense {
  id            String   @id @default(cuid())
  drugId        String
  patientId     String
  quantity      Int
  unitPrice     Float
  totalPrice    Float
  paymentStatus PaymentStatus @default(PENDING)
  dispensedBy   String   // User ID of pharmacist
  dispensedAt   DateTime @default(now())
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  drug    Drug    @relation(fields: [drugId], references: [id])
  patient Patient @relation(fields: [patientId], references: [id])

  @@map("pharmacy_dispenses")
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELLED
}

// Unified billing model to track all patient charges
model PatientBilling {
  id            String   @id @default(cuid())
  patientId     String
  description   String   // e.g., "Consultation - Dr. Smith", "Ward Admission - Bed 5A"
  chargeType    ChargeType
  amount        Float
  isPaid        Boolean  @default(false)
  paidAt        DateTime?
  relatedId     String?  // ID of related appointment, admission, or dispense
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])

  @@map("patient_billing")
}

enum ChargeType {
  APPOINTMENT
  ADMISSION
  PHARMACY
  OTHER
}

model Prescription {
  id        String   @id @default(cuid())
  patientId String
  doctorId  String
  date      DateTime @default(now())
  diagnosis String?
  notes     String?
  status    PrescriptionStatus @default(PRESCRIBED)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient Patient            @relation(fields: [patientId], references: [id])
  doctor  Doctor             @relation(fields: [doctorId], references: [id])
  items   PrescriptionItem[]

  @@map("prescriptions")
}

enum PrescriptionStatus {
  PRESCRIBED
  PARTIALLY_DISPENSED
  FULLY_DISPENSED
}

model PrescriptionItem {
  id             String   @id @default(cuid())
  prescriptionId String
  drugId         String
  quantity       Int
  dosage         String   // e.g., "1 tablet twice daily"
  duration       String   // e.g., "7 days"
  instructions   String?
  dispensed      Int      @default(0) // quantity dispensed
  createdAt      DateTime @default(now())

  prescription Prescription    @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  drug         Drug            @relation(fields: [drugId], references: [id])
  issues       PharmacyIssue[]

  @@map("prescription_items")
}

model Pharmacist {
  id        String   @id @default(cuid())
  userId    String   @unique
  licenseNumber String @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  issues PharmacyIssue[]

  @@map("pharmacists")
}

model PharmacyIssue {
  id                 String   @id @default(cuid())
  prescriptionItemId String
  pharmacistId       String
  drugId             String
  quantityIssued     Int
  issuedDate         DateTime @default(now())
  notes              String?

  prescriptionItem PrescriptionItem @relation(fields: [prescriptionItemId], references: [id])
  pharmacist       Pharmacist       @relation(fields: [pharmacistId], references: [id])
  drug             Drug             @relation(fields: [drugId], references: [id])

  @@map("pharmacy_issues")
}

model Service {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique
  category    String   // CONSULTATION, PROCEDURE, ROOM_CHARGE, etc.
  price       Float
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  billItems BillItem[]

  @@map("services")
}

model Bill {
  id           String     @id @default(cuid())
  billNumber   String     @unique
  patientId    String
  billDate     DateTime   @default(now())
  totalAmount  Float      @default(0)
  discountAmount Float    @default(0)
  netAmount    Float      @default(0)
  paidAmount   Float      @default(0)
  dueAmount    Float      @default(0)
  status       BillStatus @default(PENDING)
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  patient  Patient    @relation(fields: [patientId], references: [id])
  items    BillItem[]
  payments Payment[]

  @@map("bills")
}

enum BillStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  CANCELLED
}

model BillItem {
  id        String   @id @default(cuid())
  billId    String
  serviceId String?
  itemName  String   // for custom items
  quantity  Int      @default(1)
  unitPrice Float
  totalPrice Float
  createdAt DateTime @default(now())

  bill    Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id])

  @@map("bill_items")
}

model Payment {
  id            String        @id @default(cuid())
  billId        String
  amount        Float
  paymentMethod PaymentMethod @default(CASH)
  paymentDate   DateTime      @default(now())
  reference     String?       // for card/online payments
  notes         String?
  createdAt     DateTime      @default(now())

  bill Bill @relation(fields: [billId], references: [id])

  @@map("payments")
}

enum PaymentMethod {
  CASH
  CARD
  ONLINE
  INSURANCE
  CHEQUE
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // CREATE, UPDATE, DELETE
  module      String   // PATIENT, APPOINTMENT, BILLING, etc.
  recordId    String   // ID of the affected record
  description String
  ipAddress   String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}
